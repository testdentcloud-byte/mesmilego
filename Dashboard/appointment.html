<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Default font */
        }


        .kanban-column-content::-webkit-scrollbar,
        .table-scroll-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .kanban-column-content::-webkit-scrollbar-thumb,
        .table-scroll-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            /* slate-300 */
            border-radius: 3px;
        }

        .kanban-column-content::-webkit-scrollbar-track,
        .table-scroll-container::-webkit-scrollbar-track {
            background-color: #f1f5f9;
            /* slate-100 */
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            border: .5rem solid #eee;
            border-top: .5rem solid #4ade80;
            /* green-400 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none !important;
            /* Ensure override */
        }

        .actionBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Tab styles */

        .tab-button.active {
            color: #4ade80;
            /* green-400 */
            border-color: #4ade80;
            /* green-400 */
            font-weight: 600;
        }

        .tab-button:not(.active) {
            color: #64748b;
            /* slate-500 */
            border-color: transparent;
        }

        .tab-button:not(.active):hover {
            color: #334155;
            /* slate-700 */
            border-color: #cbd5e1;
            /* slate-300 */
        }
    </style>
</head>

<body class="bg-slate-100">
    <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-[100]">
        <div class="spinner"></div>
    </div>

    <div id="customAlertOverlay"
        class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-[100]">
        <div class="bg-white p-6 rounded shadow-lg text-center w-80 font-thai">
            <p id="customAlertMessage" class="mb-6 text-gray-700 text-sm"></p>
            <div class="flex justify-center gap-4">
                <button id="customAlertCancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="customAlertOk" class="bg-green-400 text-white px-4 py-2 rounded">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-white p-5 border-r border-slate-200 flex flex-col">
            <div class="flex items-center space-x-2 mb-8">
                <div class="bg-green-400 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <h1 class="text-xl font-bold text-slate-800">ME-SMILE</h1>
            </div>
            <div class="bg-slate-50 p-3 rounded-lg mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div>
                            <p id="adminName" class="text-sm font-semibold text-slate-700 font-thai">Dashboard User</p>
                            <p class="text-xs text-slate-500 font-thai">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-red-500 hover:text-red-700 text-sm font-thai">
                        logout
                    </button>
                </div>
            </div>
             <nav class="flex-grow space-y-1">
                <p class="text-xs text-slate-400 uppercase font-semibold px-3 mb-2">Main Menu</p>
                <a href="book.html"
                    class="flex items-center space-x-3 px-3 py-2.5 text-slate-600 hover:bg-indigo-50 hover:text-green-700 rounded-md text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    <span>‡∏à‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</span>
                </a>
                <a href="appointment.html"
                    class="flex items-center space-x-3 px-3 py-2.5 bg-green-100 text-green-700 rounded-md text-sm font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</span>
                </a>
                <a href="service.html"
                    class="flex items-center space-x-3 px-3 py-2.5 text-slate-600 hover:bg-indigo-50 hover:text-green-700 rounded-md text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                </a>
                <a href="member.html"
                    class="flex items-center space-x-3 px-3 py-2.5 text-slate-600 hover:bg-indigo-50 hover:text-green-700 rounded-md text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
                </a>
                <a href="doctor.html"
                    class="flex items-center space-x-3 px-3 py-2.5 text-slate-600 hover:bg-indigo-50 hover:text-green-700 rounded-md text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏≠</span>
                </a>
                <a href="setting.html"
                    class="flex items-center space-x-3 px-3 py-2.5 text-slate-600 hover:bg-indigo-50 hover:text-green-700 rounded-md text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                </a>
            </nav>
        </aside>

<main class="flex-1 flex flex-col min-w-0">            <header class="bg-white border-b border-slate-200 p-4 flex items-center justify-between">
                <div class="relative w-1/3">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </span>
                    <input type="text" id="nameSearch" placeholder="Search name..."
                        class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center gap-2">
                        <label for="branchSelector" class="text-sm font-medium text-slate-700 font-thai">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô :</label>
                        <select id="branchSelector" class="p-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 font-thai">
                            <option value="1">CPF ‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ 1</option>
                            <option value="2">CPF ‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ 2</option>
                        </select>
                    </div>

                </div>
            </header>

            <div class="flex-1 p-6 overflow-y-auto">
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold text-slate-800 font-thai">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h2>
                </div>

                <div class="mb-6">
                    <div class="border-b border-slate-200">
                        <nav id="tabsContainer" class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button data-tab-target="#kanbanViewContent"
                                class="tab-button whitespace-nowrap py-3 px-1 border-b-2 text-sm font-thai active">
                                ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î
                            </button>
                            <button data-tab-target="#listViewContent"
                                class="tab-button whitespace-nowrap py-3 px-1 border-b-2 text-sm font-thai">
                                ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            </button>
                        </nav>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4 gap-3">
                    <h3 class="text-xl font-semibold text-slate-800 font-thai">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h3>
                    <div class="flex flex-wrap items-center space-x-0 md:space-x-3 gap-2 md:gap-0">
                        <select id="statusFilter"
                            class="p-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 font-thai">
                            <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</option>
                            <option value="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
                            <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                            <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                        </select>
                        <select id="dateSort"
                            class="p-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 font-thai">
                            <option value="latest">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                            <option value="oldest">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                        </select>
                        <button id="exportCsvBtn"
                            class="flex items-center gap-2 p-2 bg-green-600 text-white rounded-md text-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 font-thai">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export CSV
                        </button>
                        <button id="exportAllBranchesBtn"
                            class="flex items-center gap-2 p-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 font-thai">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export ‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤
                        </button>
                    </div>
                </div>

                <div id="kanbanViewContent" data-tab-content>
                    <div class="flex space-x-4 pb-4 overflow-x-auto">
                        <div class="bg-slate-50 rounded-lg w-80 md:w-72 flex-shrink-0">
                            <div class="p-3 border-t-4 border-yellow-400 rounded-t-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-sm font-semibold text-slate-700 uppercase font-thai">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                                    </h4><span id="sourced-count"
                                        class="text-xs bg-yellow-200 text-yellow-800 font-medium px-2 py-0.5 rounded-full">0</span>
                                </div>
                            </div>
                            <div id="sourced-column-content"
                                class="p-3 pt-0 space-y-3 kanban-column-content max-h-[calc(100vh-380px)] overflow-y-auto">
                            </div>
                        </div>
                        <div class="bg-slate-50 rounded-lg w-80 md:w-72 flex-shrink-0">
                            <div class="p-3 border-t-4 border-blue-400 rounded-t-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-sm font-semibold text-slate-700 uppercase font-thai">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h4>
                                    <span id="inprogress-count"
                                        class="text-xs bg-blue-200 text-blue-800 font-medium px-2 py-0.5 rounded-full">0</span>
                                </div>
                            </div>
                            <div id="inprogress-column-content"
                                class="p-3 pt-0 space-y-3 kanban-column-content max-h-[calc(100vh-380px)] overflow-y-auto">
                            </div>
                        </div>
                        <div class="bg-slate-50 rounded-lg w-80 md:w-72 flex-shrink-0">
                            <div class="p-3 border-t-4 border-green-400 rounded-t-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-sm font-semibold text-slate-700 uppercase font-thai">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</h4>
                                    <span id="hired-count"
                                        class="text-xs bg-green-200 text-green-800 font-medium px-2 py-0.5 rounded-full">0</span>
                                </div>
                            </div>
                            <div id="hired-column-content"
                                class="p-3 pt-0 space-y-3 kanban-column-content max-h-[calc(100vh-380px)] overflow-y-auto">
                            </div>
                        </div>
                        <div class="bg-slate-50 rounded-lg w-80 md:w-72 flex-shrink-0">
                            <div class="p-3 border-t-4 border-red-400 rounded-t-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-sm font-semibold text-slate-700 uppercase font-thai">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</h4>
                                    <span id="rejected-count"
                                        class="text-xs bg-red-200 text-red-800 font-medium px-2 py-0.5 rounded-full">0</span>
                                </div>
                            </div>
                            <div id="rejected-column-content"
                                class="p-3 pt-0 space-y-3 kanban-column-content max-h-[calc(100vh-380px)] overflow-y-auto">
                            </div>
                        </div>
                    </div>
                </div>

<div id="listViewContent" data-tab-content class="hidden">
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="overflow-x-auto w-full">
            <table class="min-w-max divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-thai">
                            ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-thai">
                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-thai">
                            ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-thai">
                            ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-thai">
                            ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£/‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-thai">
                            ‡πÇ‡∏£‡∏Ñ/‡πÅ‡∏û‡πâ‡∏¢‡∏≤</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-thai">
                            ‡∏´‡∏°‡∏≠</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-thai">
                            ‡∏´‡πâ‡∏≠‡∏á</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-thai">
                            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-thai">
                            ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-thai min-w-[320px]">
                            ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="appointmentTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>

        <div id="listPagination"
            class="p-4 border-t border-gray-200 flex justify-between items-center text-sm text-gray-600">
        </div>
    </div>
</div>
            </div>
        </main>
    </div>

    <!-- Modal for Adding Doctor Info -->
    <div id="doctorInfoModal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-[100]">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md font-thai">
            <h3 class="text-xl font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏≠‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á</h3>
            <form id="doctorInfoForm">
                <input type="hidden" id="appointmentId" />
                <input type="hidden" id="appointmentDate" />

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≠</label>
                    <select id="doctorSelect" required class="w-full border border-gray-300 rounded px-3 py-2">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≠ --</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</label>
                    <select id="roomSelect" required class="w-full border border-gray-300 rounded px-3 py-2">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
                        <option value="‡∏´‡πâ‡∏≠‡∏á1">‡∏´‡πâ‡∏≠‡∏á 1</option>
                        <option value="‡∏´‡πâ‡∏≠‡∏á2">‡∏´‡πâ‡∏≠‡∏á 2</option>
                    </select>
                </div>

                <div class="flex gap-3 justify-end">
                    <button type="button" id="cancelDoctorInfoBtn"
                        class="bg-gray-300 text-gray-800 px-4 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <script src="Config.js"></script>
    <script>
        // (A) ‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏à‡∏≤‡∏Å localStorage
        document.addEventListener('DOMContentLoaded', () => {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
            const isLoggedIn = localStorage.getItem('isAdminLoggedIn') === 'true';
            if (!isLoggedIn) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                window.location.href = 'login.html';
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
            }

            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠ admin ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
            const adminName = localStorage.getItem('adminName') || 'Admin';
            document.getElementById('adminName').textContent = adminName;
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Logout (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        function logout() {
            localStorage.removeItem('isAdminLoggedIn');
            localStorage.removeItem('adminName');
            localStorage.removeItem('adminBranches');
            localStorage.removeItem('branch');
            window.location.href = 'login.html';
        }

        let allAppointmentsData = [];
        let currentView = 'kanban'; // 'kanban' or 'list'
        let currentPage = 1;
        const itemsPerPage = 10;


        const loadingOverlay = document.getElementById('loadingOverlay');
        const alertOverlay = document.getElementById('customAlertOverlay');
        const alertMessageEl = document.getElementById('customAlertMessage');
        const alertOkBtn = document.getElementById('customAlertOk');
        const alertCancelBtn = document.getElementById('customAlertCancel');

        const nameSearchInput = document.getElementById('nameSearch');
        const statusFilterSelect = document.getElementById('statusFilter');
        const dateSortSelect = document.getElementById('dateSort');

        const tabsContainer = document.getElementById('tabsContainer');
        const tabContents = document.querySelectorAll('[data-tab-content]');
        const kanbanViewContent = document.getElementById('kanbanViewContent');
        const listViewContent = document.getElementById('listViewContent');
        const appointmentTableBody = document.getElementById('appointmentTableBody');
        const listPaginationContainer = document.getElementById('listPagination');


        const columnContents = {
            sourced: document.getElementById('sourced-column-content'),
            inprogress: document.getElementById('inprogress-column-content'),
            // interview: REMOVED
            hired: document.getElementById('hired-column-content'),
            rejected: document.getElementById('rejected-column-content'),
        };
        const columnCounts = {
            sourced: document.getElementById('sourced-count'),
            inprogress: document.getElementById('inprogress-count'),
            // interview: REMOVED
            hired: document.getElementById('hired-count'),
            rejected: document.getElementById('rejected-count'),
        };

        const showLoading = () => loadingOverlay.classList.remove('hidden');
        const hideLoading = () => loadingOverlay.classList.add('hidden');

        function showAlert(msg, onConfirm, onCancel, showCancelButton = true) {
            alertMessageEl.textContent = msg;
            alertOverlay.classList.remove('hidden');
            alertOverlay.classList.add('flex');
            alertOkBtn.onclick = () => {
                alertOverlay.classList.add('hidden');
                alertOverlay.classList.remove('flex');
                if (onConfirm) onConfirm();
            };
            if (showCancelButton) {
                alertCancelBtn.style.display = 'inline-block';
                alertCancelBtn.onclick = () => {
                    alertOverlay.classList.add('hidden');
                    alertOverlay.classList.remove('flex');
                    if (onCancel) onCancel();
                };
            } else {
                alertCancelBtn.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Branch selector logic with admin permissions
            const branchSelector = document.getElementById('branchSelector');
            const savedBranch = localStorage.getItem('branch') || '1';
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
            const adminBranchesStr = localStorage.getItem('adminBranches');
            const adminBranches = adminBranchesStr ? JSON.parse(adminBranchesStr) : ['1'];
            
            // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if (adminBranches[0] !== 'all') {
                // ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                const options = branchSelector.querySelectorAll('option');
                options.forEach(opt => {
                    if (!adminBranches.includes(opt.value)) {
                        opt.remove();
                    }
                });
                
                // ‡∏ñ‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                if (!adminBranches.includes(savedBranch)) {
                    localStorage.setItem('branch', adminBranches[0]);
                    branchSelector.value = adminBranches[0];
                } else {
                    branchSelector.value = savedBranch;
                }
            } else {
                branchSelector.value = savedBranch;
            }
            
            branchSelector.addEventListener('change', function() {
                localStorage.setItem('branch', this.value);
                location.reload();
            });

            fetchInitialData();
            statusFilterSelect.addEventListener('change', () => {
                currentPage = 1;
                renderCurrentView();
            });
            dateSortSelect.addEventListener('change', () => {
                currentPage = 1;
                renderCurrentView();
            });
            nameSearchInput.addEventListener('input', () => {
                currentPage = 1;
                renderCurrentView();
            });

            document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
            document.getElementById('exportAllBranchesBtn').addEventListener('click', exportAllBranchesToCsv);
        /**
         * Export all branches (hardcoded ['1','2'] but can be extended)
         */
        async function exportAllBranchesToCsv() {
            showLoading();
            try {
                // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô ['1','2','3','4']
                const branches = ['1', '2'];
                let allData = [];
                for (const branch of branches) {
                    const res = await fetch(`${WEB_APP_URL}?action=fetchBookings&branch=${branch}`);
                    if (res.ok) {
                        const data = await res.json();
                        allData = allData.concat(data.map(d => ({ ...d, branch })));
                    }
                }
                if (allData.length === 0) {
                    showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export', null, null, false);
                    hideLoading();
                    return;
                }
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢) ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                const headers = [
                    '‡∏£‡∏´‡∏±‡∏™', '‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏≠‡∏î‡∏µ', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£', '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£/‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô',
                    '‡πÇ‡∏£‡∏Ñ/‡πÅ‡∏û‡πâ', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤',
                    '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'CalendarEventId', '‡∏´‡∏°‡∏≠', '‡∏´‡πâ‡∏≠‡∏á', '‡∏™‡∏≤‡∏Ç‡∏≤'
                ];
                const rows = allData.map(item => [
                    sanitizeCsvField(item.idKey),
                    sanitizeCsvField(item.userlineid),
                    sanitizeCsvField(item.firstName),
                    sanitizeCsvField(item.lastName),
                    sanitizeCsvField(item.phonenumber),
                    sanitizeCsvField(item.idCardOrSocial),
                    sanitizeCsvField(item.diseaseAllergy),
                    sanitizeCsvField(item.note),
                    sanitizeCsvField(item.service),
                    sanitizeCsvField(item.price),
                    sanitizeCsvField(item.date),
                    sanitizeCsvField(item.time),
                    sanitizeCsvField(item.status),
                    sanitizeCsvField(item.timestamp),
                    sanitizeCsvField(item.calendarEventId),
                    sanitizeCsvField(item.doctor),
                    sanitizeCsvField(item.room),
                    sanitizeCsvField(item.branch)
                ].join(','));
                const csvContent = [headers.join(','), ...rows].join('\n');
                const blob = new Blob(['\uFEFF' + csvContent], {
                    type: 'text/csv;charset=utf-8;'
                });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    const today = new Date().toISOString().slice(0, 10);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `appointments-all-branches-${today}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            } catch (err) {
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, null, null, false);
            } finally {
                hideLoading();
            }
        }

            tabsContainer.addEventListener('click', (e) => {
                const targetButton = e.target.closest('.tab-button');
                if (!targetButton) return;

                tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                targetButton.classList.add('active');

                tabContents.forEach(content => content.classList.add('hidden'));
                const targetContentId = targetButton.dataset.tabTarget;
                document.querySelector(targetContentId).classList.remove('hidden');

                currentView = targetContentId === '#kanbanViewContent' ? 'kanban' : 'list';
                currentPage = 1; // Reset page on tab switch
                renderCurrentView();
            });
            // Set initial active tab content
            document.querySelector('#kanbanViewContent').classList.remove('hidden');
        });

        async function fetchInitialData() {
            showLoading();
            try {
                const branch = localStorage.getItem('branch') || '1';
                const res = await fetch(`${WEB_APP_URL}?action=fetchBookings&branch=${branch}`);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                allAppointmentsData = data.map(d => {
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ firstName/lastName ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô name
                    let name = d.name;
                    if (!name && (d.firstName || d.lastName)) {
                        name = ((d.firstName || '') + ' ' + (d.lastName || '')).trim();
                    }
                    return {
                        ...d,
                        name,
                        parsedDate: new Date(d.date.split('-').reverse().join('-') + 'T' + d.time)
                    };
                });
                renderCurrentView();
            } catch (err) {
                console.error("Error fetching initial data:", err);
                showAlert(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err.message}`, null, null, false);
            } finally {
                hideLoading();
            }
        }

        function filterAndSortData() {
            let filtered = [...allAppointmentsData];
            const searchTerm = nameSearchInput.value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(d => d.name.toLowerCase().includes(searchTerm) || d.phonenumber.includes(searchTerm) || d.service.toLowerCase().includes(searchTerm));
            }
            const status = statusFilterSelect.value;
            if (status) {
                filtered = filtered.filter(d => d.status === status);
            }
            const sortOrder = dateSortSelect.value;
            filtered.sort((a, b) => sortOrder === 'latest' ? b.parsedDate - a.parsedDate : a.parsedDate - b.parsedDate);
            return filtered;
        }

        function renderCurrentView() {
            const dataToRender = filterAndSortData();
            if (currentView === 'kanban') {
                renderKanbanView(dataToRender);
            } else {
                renderListView(dataToRender);
            }
        }

        function renderKanbanView(data) {
            Object.values(columnContents).forEach(col => col.innerHTML = '');
            Object.values(columnCounts).forEach(countEl => countEl.textContent = '0');
            let counts = {
                sourced: 0,
                inprogress: 0,
                /* interview: 0, REMOVED */
                hired: 0,
                rejected: 0
            };

            const placeholder = `<p class="text-xs text-slate-400 text-center p-4 font-thai">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>`;
            if (data.length === 0) {
                Object.values(columnContents).forEach(col => col.innerHTML = placeholder);
                return;
            }

            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-md shadow border border-gray-200';
                let targetColumnKey;
                switch (item.status) {
                    case '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô':
                        targetColumnKey = 'sourced';
                        break;
                    case '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß':
                        targetColumnKey = 'inprogress';
                        break;
                    case '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô':
                        targetColumnKey = 'hired';
                        break;
                    case '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å':
                        targetColumnKey = 'rejected';
                        break;
                    default:
                        targetColumnKey = 'sourced';
                }
                counts[targetColumnKey]++;
                card.innerHTML = getCardOrRowHtml(item, 'card'); // Use helper
                if (columnContents[targetColumnKey]) {
                    if (columnContents[targetColumnKey].innerHTML.includes(placeholder.substring(0, 30))) { // Check if placeholder exists
                        columnContents[targetColumnKey].innerHTML = '';
                    }
                    columnContents[targetColumnKey].appendChild(card);
                }
            });
            for (const key in counts) {
                if (columnCounts[key]) columnCounts[key].textContent = counts[key];
            }
            Object.keys(columnContents).forEach(key => {
                if (counts[key] === 0 && columnContents[key]) {
                    columnContents[key].innerHTML = placeholder;
                }
            });
            attachActionListeners();
        }

        function renderListView(data) {
            appointmentTableBody.innerHTML = '';
            const totalItems = data.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const paginatedData = data.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            if (paginatedData.length === 0) {
                appointmentTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500 p-4 font-thai">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>`;
                renderPagination(0, 0, 0); // Clear pagination
                return;
            }

            paginatedData.forEach(item => {
                const row = appointmentTableBody.insertRow();
                row.className = "hover:bg-gray-50";
                row.innerHTML = getCardOrRowHtml(item, 'row'); // Use helper
            });
            renderPagination(totalItems, currentPage, totalPages);
            attachActionListeners();
        }

        function getCardOrRowHtml(item, type) {
            const buttonsHtml = `
                <button class="actionBtn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs font-thai" data-action="confirmBooking" data-id="${item.idKey}" ${item.status !== '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' ? 'disabled' : ''}>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                <button class="actionBtn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-thai" data-action="cancelBooking" data-id="${item.idKey}" ${['‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'].includes(item.status) ? 'disabled' : ''}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="actionBtn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-thai" data-action="completeBooking" data-id="${item.idKey}" ${['‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'].includes(item.status) || item.status === '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' ? 'disabled' : ''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                <button class="actionBtn bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs font-thai" data-action="sendReminder" data-id="${item.idKey}" ${item.status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' || item.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'disabled' : ''}>‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button> 
                <button class="actionBtn bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs font-thai" data-action="sendReminderWithoutPayment" data-id="${item.idKey}" ${item.status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' || item.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'disabled' : ''}>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
                <button class="actionBtn bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs font-thai" data-action="addDoctorInfo" data-id="${item.idKey}" data-date="${item.date}">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            `;

            if (type === 'card') {
                return `
                    <div class="mb-2">
                        <h3 class="text-base font-semibold text-slate-800 font-thai truncate" title="${item.name}">${item.name}</h3>
                        <p class="text-xs text-slate-500 font-thai">üìÖ ${item.date} @ ${item.time}</p>
                    </div>
                    <div class="text-xs text-slate-600 space-y-0.5 mb-3 font-thai">
                        <p><strong>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</strong> ${item.service}</p>
                        <p><strong>‡πÇ‡∏ó‡∏£:</strong> ${item.phonenumber}</p>
                        <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£/‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°:</strong> ${item.idCardOrSocial || '-'}</p>
                        <p><strong>‡πÇ‡∏£‡∏Ñ/‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</strong> ${item.diseaseAllergy || '-'}</p>
                        <p class="truncate" title="${item.note || '-'}"><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${item.note || '-'}</p>
                        <p><strong>‡∏´‡∏°‡∏≠:</strong> ${item.doctor || '-'}</p>
                        <p><strong>‡∏´‡πâ‡∏≠‡∏á:</strong> ${item.room || '-'}</p>
                        <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${item.status}</p>
                    </div>
                    <div class="flex flex-wrap gap-1.5">
                        ${buttonsHtml}
                    </div>`;
            } else if (type === 'row') {
                return `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 font-thai sticky left-0 bg-white z-10">${item.name}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-thai">${item.date} ${item.time}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-thai">${item.service}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-thai">${item.phonenumber}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-thai">${item.idCardOrSocial || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-thai">${item.diseaseAllergy || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-thai">${item.doctor || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-thai">${item.room || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-thai">${item.status}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 font-thai max-w-xs truncate" title="${item.note || '-'}">${item.note || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                        <div class="flex flex-wrap gap-1.5">
                           ${buttonsHtml}
                        </div>
                    </td>`;
            }
            return '';
        }

        function renderPagination(totalItems, page, totalPages) {
            listPaginationContainer.innerHTML = '';
            if (totalItems === 0) return;

            const startItem = (page - 1) * itemsPerPage + 1;
            const endItem = Math.min(page * itemsPerPage, totalItems);

            let paginationHTML = `<span class="font-thai">‡πÅ‡∏™‡∏î‡∏á ${startItem}-${endItem} ‡∏à‡∏≤‡∏Å ${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>`;
            paginationHTML += `<div class="flex gap-1">`;

            if (page > 1) {
                paginationHTML += `<button data-page="${page - 1}" class="page-btn px-3 py-1 border border-gray-300 rounded bg-white hover:bg-gray-50 font-thai">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>`;
            } else {
                paginationHTML += `<button class="px-3 py-1 border border-gray-300 rounded bg-gray-100 text-gray-400 cursor-not-allowed font-thai">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>`;
            }

            let startPage = Math.max(1, page - 2);
            let endPage = Math.min(totalPages, page + 2);

            if (startPage > 1) paginationHTML += `<span class="px-3 py-1">...</span>`;

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button data-page="${i}" class="page-btn px-3 py-1 border rounded ${i === page ? 'bg-indigo-500 text-white border-indigo-500' : 'bg-white border-gray-300 hover:bg-gray-50'}">${i}</button>`;
            }
            if (endPage < totalPages) paginationHTML += `<span class="px-3 py-1">...</span>`;


            if (page < totalPages) {
                paginationHTML += `<button data-page="${page + 1}" class="page-btn px-3 py-1 border border-gray-300 rounded bg-white hover:bg-gray-50 font-thai">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>`;
            } else {
                paginationHTML += `<button class="px-3 py-1 border border-gray-300 rounded bg-gray-100 text-gray-400 cursor-not-allowed font-thai">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>`;
            }
            paginationHTML += `</div>`;
            listPaginationContainer.innerHTML = paginationHTML;

            document.querySelectorAll('.page-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentPage = parseInt(e.target.dataset.page);
                    renderListView(filterAndSortData());
                });
            });
        }


        function attachActionListeners() {
            document.querySelectorAll('.actionBtn').forEach(btn => {
                btn.onclick = () => {
                    if (btn.disabled) return;
                    const action = btn.dataset.action;
                    const id = btn.dataset.id;

                    // Handle addDoctorInfo action separately
                    if (action === 'addDoctorInfo') {
                        const date = btn.dataset.date;
                        openDoctorInfoModal(id, date);
                        return;
                    }

                    const actionTextMap = {
                        confirmBooking: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢',
                        cancelBooking: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢',
                        completeBooking: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢',
                        sendReminder: '‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', // New action text
                        sendReminderWithPayment: '‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
                        sendReminderWithoutPayment: '‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ü‡∏£‡∏µ)'
                    };
                    confirmAction(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "${actionTextMap[action] || action}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, action, id);
                };
            });
        }

        function confirmAction(message, action, id) {
            showAlert(message, () => {
                showLoading();
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ branch ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                const appointment = allAppointmentsData.find(appt => appt.idKey === id);
                const branch = appointment && appointment.branch ? appointment.branch : (localStorage.getItem('branch') || '1');
                
                fetch(`${WEB_APP_URL}?action=${action}&id=${encodeURIComponent(id)}&branch=${branch}`, {
                    method: 'POST'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(text => {
                        console.log('Action response:', text);
                        hideLoading();
                        fetchInitialData();
                    })
                    .catch(err => {
                        console.error('Error during action:', err);
                        hideLoading();
                        showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: ${err.message}`);
                    });
            });
        }

        /**
         * Sanitize a string for CSV format.
         * - If it contains a comma, newline, or double quote, wrap it in double quotes.
         * - If it contains double quotes, escape them by doubling them.
         * @param {string} field The data to sanitize.
         * @returns {string} The sanitized CSV field.
         */
        function sanitizeCsvField(field) {
            const str = String(field || ''); // Ensure it's a string, handle null/undefined
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                const escapedStr = str.replace(/"/g, '""');
                return `"${escapedStr}"`;
            }
            return str;
        }


        /**
         * Exports the currently filtered and sorted appointment data to a CSV file.
         */
        function exportToCsv() {
            const dataToExport = filterAndSortData();

            if (dataToExport.length === 0) {
                showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export', null, null, false);
                return;
            }

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢) ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            const headers = [
                '‡∏£‡∏´‡∏±‡∏™', '‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏≠‡∏î‡∏µ', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£', '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£/‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô',
                '‡πÇ‡∏£‡∏Ñ/‡πÅ‡∏û‡πâ', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤',
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'CalendarEventId', '‡∏´‡∏°‡∏≠', '‡∏´‡πâ‡∏≠‡∏á', '‡∏™‡∏≤‡∏Ç‡∏≤'
            ];

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞ object ‡πÄ‡∏õ‡πá‡∏ô row ‡∏Ç‡∏≠‡∏á CSV
            const rows = dataToExport.map(item => [
                sanitizeCsvField(item.idKey),
                sanitizeCsvField(item.userlineid),
                sanitizeCsvField(item.firstName),
                sanitizeCsvField(item.lastName),
                sanitizeCsvField(item.phonenumber),
                sanitizeCsvField(item.idCardOrSocial),
                sanitizeCsvField(item.diseaseAllergy),
                sanitizeCsvField(item.note),
                sanitizeCsvField(item.service),
                sanitizeCsvField(item.price),
                sanitizeCsvField(item.date),
                sanitizeCsvField(item.time),
                sanitizeCsvField(item.status),
                sanitizeCsvField(item.timestamp),
                sanitizeCsvField(item.calendarEventId),
                sanitizeCsvField(item.doctor),
                sanitizeCsvField(item.room),
                sanitizeCsvField(item.branch)
            ].join(','));

            // ‡∏£‡∏ß‡∏° Header ‡πÅ‡∏•‡∏∞ Rows ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
            const csvContent = [headers.join(','), ...rows].join('\n');

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° BOM (Byte Order Mark) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Excel ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå UTF-8 (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢) ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            const blob = new Blob(['\uFEFF' + csvContent], {
                type: 'text/csv;charset=utf-8;'
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Link ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                const today = new Date().toISOString().slice(0, 10);
                link.setAttribute("href", url);
                link.setAttribute("download", `appointments-${today}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // ========== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏≠ ==========
        const doctorInfoModal = document.getElementById('doctorInfoModal');
        const cancelDoctorInfoBtn = document.getElementById('cancelDoctorInfoBtn');
        const doctorInfoForm = document.getElementById('doctorInfoForm');
        const doctorSelect = document.getElementById('doctorSelect');

        cancelDoctorInfoBtn.addEventListener('click', () => {
            doctorInfoModal.classList.add('hidden');
            doctorInfoModal.classList.remove('flex');
        });

        async function openDoctorInfoModal(appointmentId, appointmentDate) {
            document.getElementById('appointmentId').value = appointmentId;
            document.getElementById('appointmentDate').value = appointmentDate;

            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á branch
            const appointment = allAppointmentsData.find(appt => appt.idKey === appointmentId);
            const branch = appointment && appointment.branch ? appointment.branch : (localStorage.getItem('branch') || '1');

            // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏≠‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤
            showLoading();
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getDoctorsByDate&date=${appointmentDate}&branch=${branch}`);
                const doctors = await response.json();

                doctorSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≠ --</option>';
                doctors.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor;
                    option.textContent = doctor;
                    doctorSelect.appendChild(option);
                });

                hideLoading();
                doctorInfoModal.classList.remove('hidden');
                doctorInfoModal.classList.add('flex');
            } catch (error) {
                hideLoading();
                showAlert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, null, null, false);
            }
        }

        doctorInfoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const appointmentId = document.getElementById('appointmentId').value;
            const appointment = allAppointmentsData.find(appt => appt.idKey === appointmentId);
            const branch = appointment && appointment.branch ? appointment.branch : (localStorage.getItem('branch') || '1');

            const formData = new FormData();
            formData.append('action', 'updateAppointmentDoctor');
            formData.append('id', appointmentId);
            formData.append('doctor', doctorSelect.value);
            formData.append('room', document.getElementById('roomSelect').value);
            formData.append('branch', branch);

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.text();
                hideLoading();
                showAlert(result, null, null, false);
                doctorInfoModal.classList.add('hidden');
                doctorInfoModal.classList.remove('flex');
                fetchInitialData(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            } catch (error) {
                hideLoading();
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, null, null, false);
            }
        });
    </script>
</body>

</html>
